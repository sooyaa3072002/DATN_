https://colab.research.google.com/drive/18BfyRvu63dAGdt76FNvJlBaGUv4cFN_k?usp=sharing

#CODE
import numpy as np
import matplotlib.pyplot as plt

# THÃ”NG Sá» Há»† THá»NG
capacity_battery = 19.2  # kWh
max_charge_power = 9.6  # kW
max_discharge_power = 19.2  # kW
soc_min = 0.2 * capacity_battery
soc_max = 0.8 * capacity_battery
efficiency_charge = 0.9
efficiency_discharge = 0.85
initial_soc = 0.5 * capacity_battery
delta_t = 1  # giá»

# GIÃ BÃN VÃ€ MUA ÄIá»†N
sell_price = 671  # VNÄ/kWh
max_grid_buy = 15
max_grid_sell = 10

# GiÃ¡ mua Ä‘iá»‡n theo khung giá» (cáº¥p dÆ°á»›i 6kV) - cáº­p nháº­t theo báº£ng báº¡n gá»­i
def get_buy_price_by_time(hour):
    if 22 <= hour or hour < 4:
        return 1830  # Tháº¥p Ä‘iá»ƒm
    elif (11 <= hour < 12) or (17 <= hour < 20):
        return  5174 # Cao Ä‘iá»ƒm
    else:
        return 3007  # BÃ¬nh thÆ°á»ng

# Dá»® LIá»†U
hours = np.arange(0, 24)
pv_power = np.array([0, 0, 0, 0, 0, 0, 0.66, 1.32, 2.42, 3.30, 3.96, 4.40, 4.62, 4.40, 3.96, 3.08, 1.98, 0.88, 0, 0, 0, 0, 0, 0])


load_power = np.array([0.61, 0.61, 0.61, 0.61, 0.61, 0.61, 1.90, 2.15, 0.30, 0.30, 0.28, 3.13, 0.685, 0.68, 0.38, 0.38, 0.38, 1.52, 3.92, 3.92, 2.02, 2.02, 0.82, 0.67])
# BIáº¾N LÆ¯U TRáº NG THÃI
soc = initial_soc
battery_state, buy_energy, sell_energy = [], [], []
charge_energy, discharge_energy = [], []
buy_cost_per_hour, sell_revenue_per_hour = [], []

def enforce_constraints(value, min_value, max_value):
    return max(min_value, min(value, max_value))

# Láº¬P Lá»ŠCH Náº P/Xáº¢
for i in range(len(hours)):
    charge_amount = 0
    discharge_amount = 0
    grid_buy = 0
    grid_sell = 0


    # KHUNG GIá»œ Sáº C (11h-15h)
    if 11 <= hours[i] < 15:
        charge_amount = min(max_charge_power, soc_max - soc, pv_power[i] * efficiency_charge)
        charge_amount = enforce_constraints(charge_amount, 0, max_charge_power)
        soc += charge_amount
        surplus = pv_power[i] - charge_amount / efficiency_charge
        grid_sell = enforce_constraints(surplus, 0, max_grid_sell)

    # KHUNG GIá»œ Xáº¢ (17h-6h)
    elif hours[i] >= 17 or hours[i] < 6:
        discharge_amount = min(max_discharge_power, soc - soc_min, load_power[i] / efficiency_discharge)
        discharge_amount = enforce_constraints(discharge_amount, 0, max_discharge_power)
        soc -= discharge_amount
        deficit = load_power[i] - discharge_amount * efficiency_discharge
        grid_buy = enforce_constraints(deficit, 0, max_grid_buy)

    # KHÃ”NG Sáº C/Xáº¢ Äá»’NG THá»œI
    if discharge_amount > 0:
        charge_amount = 0
    if charge_amount > 0:
        discharge_amount = 0

    soc = enforce_constraints(soc, soc_min, soc_max)

    # GIÃ ÄIá»†N THEO KHUNG GIá»œ
    buy_price_hourly = get_buy_price_by_time(hours[i])

    # LÆ¯U Káº¾T QUáº¢
    charge_energy.append(charge_amount)
    discharge_energy.append(discharge_amount)
    battery_state.append(soc)
    buy_energy.append(grid_buy)
    sell_energy.append(grid_sell)
    buy_cost_per_hour.append(grid_buy * buy_price_hourly)
    sell_revenue_per_hour.append(grid_sell * sell_price)

# TÃNH Tá»”NG
cumulative_buy_cost = np.cumsum(buy_cost_per_hour)
cumulative_sell_revenue = np.cumsum(sell_revenue_per_hour)

# BIá»‚U Äá»’
plt.figure(figsize=(10, 6))
plt.plot(hours, pv_power, 'b-o', label="CÃ´ng suáº¥t PV (kW)")
plt.plot(hours, load_power, color='orange', marker='o', label="Phá»¥ táº£i (kW)")
plt.plot(hours, buy_energy, 'g-o', label="Mua tá»« lÆ°á»›i (kW)")
plt.plot(hours, sell_energy, 'r-o', label="BÃ¡n lÃªn lÆ°á»›i (kW)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("CÃ´ng suáº¥t (kW)")
plt.title("CÃ´ng suáº¥t PV, Phá»¥ táº£i, Mua/BÃ¡n theo giá»")
plt.xticks(hours)
plt.legend()
plt.grid(True, linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()

plt.figure(figsize=(10, 6))
plt.plot(hours, battery_state, color='purple', marker='o', label="SOC cá»§a pin (kWh)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("Dung lÆ°á»£ng pin (kWh)")
plt.title("Tráº¡ng thÃ¡i SOC cá»§a pin theo thá»i gian")
plt.xticks(hours)
plt.legend()
plt.grid(True, linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()

plt.figure(figsize=(10, 6))
plt.plot(hours, cumulative_buy_cost, 'g-o', label="Chi phÃ­ mua tÃ­ch lÅ©y (VNÄ)")
plt.plot(hours, cumulative_sell_revenue, 'r-o', label="Doanh thu bÃ¡n tÃ­ch lÅ©y (VNÄ)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("VNÄ")
plt.title("Chi phÃ­ mua vÃ  doanh thu bÃ¡n Ä‘iá»‡n tÃ­ch lÅ©y")
plt.xticks(hours)
plt.legend()
plt.grid(True, linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()

# IN Báº¢NG Láº¬P Lá»ŠCH
print("\n===== ğŸ“‹ Chi tiáº¿t láº­p lá»‹ch mua/bÃ¡n vÃ  sáº¡c/xáº£ Ä‘iá»‡n theo tá»«ng giá» =====")
print("Giá» |  Mua lÆ°á»›i (kW) | Chi phÃ­ (VNÄ) | BÃ¡n lÆ°á»›i (kW) | Doanh thu (VNÄ) |  Sáº¡c (kW) |  Xáº£ (kW) |  SOC (kWh)")
print("-" * 100)

for t in hours:
    print(f"{t:>2}  | {buy_energy[t]:>13.2f} | {buy_cost_per_hour[t]:>13,.0f} | "
          f"{sell_energy[t]:>13.2f} | {sell_revenue_per_hour[t]:>15,.0f} | "
          f"{charge_energy[t]:>9.2f} | {discharge_energy[t]:>8.2f} | {battery_state[t]:>10.2f}")

# Tá»”NG Káº¾T
total_buy_energy = sum(buy_energy)
total_sell_energy = sum(sell_energy)
total_buy_cost = sum(buy_cost_per_hour)
total_sell_revenue = sum(sell_revenue_per_hour)
net_cost = total_buy_cost - total_sell_revenue

print("\n===== ğŸ“Š Tá»•ng káº¿t trong ngÃ y =====")
print(f"ğŸ”¹ Tá»•ng Ä‘iá»‡n mua tá»« lÆ°á»›i:       {total_buy_energy:.2f} kWh")
print(f"ğŸ”¹ Tá»•ng Ä‘iá»‡n bÃ¡n lÃªn lÆ°á»›i:      {total_sell_energy:.2f} kWh")
print(f"ğŸ”¹ Tá»•ng chi phÃ­ mua Ä‘iá»‡n:       {total_buy_cost:,.0f} VNÄ")
print(f"ğŸ”¹ Tá»•ng doanh thu bÃ¡n Ä‘iá»‡n:     {total_sell_revenue:,.0f} VNÄ")
print(f"ğŸ”¹ ğŸ“‰ Tá»•ng chi phÃ­ thá»±c táº¿:       {net_cost:,.0f} VNÄ")

# ===== âš¡ TÃNH Tá»¶ Lá»† Sá»¬ Dá»¤NG ÄIá»†N Máº¶T TRá»œI VÃ€ Sá» CHU Ká»² Sáº C/Xáº¢ =====

# Tá»•ng nÄƒng lÆ°á»£ng táº£i tiÃªu thá»¥ trong ngÃ y
total_load_energy = sum(load_power)

# Tá»•ng nÄƒng lÆ°á»£ng Ä‘Æ°á»£c cung cáº¥p tá»« pin (sau hiá»‡u suáº¥t)
total_discharge_supplied = sum([d * efficiency_discharge for d in discharge_energy])

# Tá»•ng nÄƒng lÆ°á»£ng tá»« PV Ä‘Æ°á»£c sá»­ dá»¥ng ná»™i bá»™ (PV trá»« pháº§n bÃ¡n lÃªn lÆ°á»›i)
total_pv_used_for_load_or_charge = sum([
    min(pv_power[i], load_power[i] + charge_energy[i] / efficiency_charge)
    for i in range(24)
])

# Tá»· lá»‡ sá»­ dá»¥ng Ä‘iá»‡n máº·t trá»i
solar_utilization_ratio = total_pv_used_for_load_or_charge / total_load_energy * 100

# TÃ­nh sá»‘ chu ká»³ sáº¡c/xáº£ trung bÃ¬nh:
# Chu ká»³ pin â‰ˆ Tá»•ng nÄƒng lÆ°á»£ng sáº¡c hoáº·c xáº£ trong ngÃ y chia cho dung lÆ°á»£ng pin
battery_cycles = min(
    sum(charge_energy) / capacity_battery,
    sum(discharge_energy) / capacity_battery
)

print("\n===== âš™ï¸ ÄÃ¡nh giÃ¡ hiá»‡u suáº¥t há»‡ thá»‘ng =====")
print(f"ğŸ”† Tá»· lá»‡ sá»­ dá»¥ng Ä‘iá»‡n máº·t trá»i:  {solar_utilization_ratio:.2f} % nhu cáº§u")
print(f"ğŸ”„ Sá»‘ chu ká»³ sáº¡c/xáº£ trong ngÃ y:  {battery_cycles:.2f} chu ká»³")

# ===== ğŸ”‹ TÃNH SOC CUá»I NGÃ€Y VÃ€ Tá»¶ Lá»† Xáº¢ PIN BAN ÄÃŠM =====

# SOC táº¡i thá»i Ä‘iá»ƒm cuá»‘i cÃ¹ng trong ngÃ y (sau giá» 23)
final_soc = battery_state[-1]

# XÃ¡c Ä‘á»‹nh cÃ¡c giá» ban Ä‘Ãªm: tá»« 18h Ä‘áº¿n 23h (tá»©c 18â€“23) + 0â€“5h hÃ´m sau
night_hours = list(range(0, 6)) + list(range(18, 24))

# Tá»•ng phá»¥ táº£i ban Ä‘Ãªm
night_load = sum([load_power[i] for i in night_hours])

# Tá»•ng nÄƒng lÆ°á»£ng xáº£ tá»« pin ban Ä‘Ãªm (tÃ­nh cáº£ hiá»‡u suáº¥t)
night_discharge_energy = sum([discharge_energy[i] * efficiency_discharge for i in night_hours])

# Tá»· lá»‡ phá»¥ táº£i ban Ä‘Ãªm do pin cung cáº¥p
night_supply_ratio = (night_discharge_energy / night_load) * 100 if night_load > 0 else 0

# In káº¿t quáº£
print("\n===== ğŸŒ™ ÄÃ¡nh giÃ¡ ban Ä‘Ãªm =====")
print(f"ğŸ”‹ SOC cuá»‘i ngÃ y (23h):                {final_soc:.2f} kWh")
print(f"ğŸŒ™ Tá»· lá»‡ táº£i ban Ä‘Ãªm do pin cung cáº¥p:  {night_supply_ratio:.2f} %")

