https://colab.research.google.com/drive/1XzuTxrUk-WXNcdXfjQ53oS_WlU3wgP_T?usp=sharing

#CODE
!pip install pulp
import numpy as np
import pulp
import matplotlib.pyplot as plt

# THÃ”NG Sá» Há»† THá»NG
capacity_battery = 19.2  # kWh
max_charge_power = 9.6  # kW
max_discharge_power = 19.2  # kW
soc_min = 0.2 * capacity_battery
soc_max = 0.8 * capacity_battery
efficiency_charge = 0.9
efficiency_discharge = 0.85
initial_soc = 0.5 * capacity_battery

# GIÃ ÄIá»†N THEO KHUNG GIá»œ
def get_buy_price_by_time(hour):
    if 22 <= hour or hour < 4:
        return 1830  # tháº¥p Ä‘iá»ƒm
    elif (11 <= hour < 12) or (17 <= hour < 20):
        return 5174  # cao Ä‘iá»ƒm
    else:
        return 3007  # bÃ¬nh thÆ°á»ng

sell_price = 671  # VNÄ/kWh (GiÃ¡ bÃ¡n Ä‘iá»‡n máº·t trá»i)

# Dá»® LIá»†U CÃ”NG SUáº¤T
hours = np.arange(0, 24)
pv_power = np.array([0, 0, 0, 0, 0, 0, 0.66, 1.32, 2.42, 3.30, 3.96, 4.40, 4.62, 4.40, 3.96, 3.08, 1.98, 0.88, 0, 0, 0, 0, 0, 0])

load_power = np.array([0.61, 0.61, 0.61, 0.61, 0.61, 0.61, 1.90, 2.15, 0.30, 0.30, 0.28, 3.13, 0.685, 0.68, 0.38, 0.38, 0.38, 1.52, 3.92, 3.92, 2.02, 2.02, 0.82, 0.67])
# KHá»I Táº O BÃ€I TOÃN MILP
model = pulp.LpProblem("Battery_Scheduling", pulp.LpMinimize)

# BIáº¾N QUYáº¾T Äá»ŠNH
P_charge = pulp.LpVariable.dicts("P_charge", hours, 0, max_charge_power)
P_discharge = pulp.LpVariable.dicts("P_discharge", hours, 0, max_discharge_power)
P_grid_buy = pulp.LpVariable.dicts("P_grid_buy", hours, 0)
P_grid_sell = pulp.LpVariable.dicts("P_grid_sell", hours, 0)
SOC = pulp.LpVariable.dicts("SOC", hours, soc_min, soc_max)
x_charge = pulp.LpVariable.dicts("x_charge", hours, 0, 1, pulp.LpBinary)
x_discharge = pulp.LpVariable.dicts("x_discharge", hours, 0, 1, pulp.LpBinary)

# HÃ€M Má»¤C TIÃŠU
model += pulp.lpSum(P_grid_buy[t] * get_buy_price_by_time(t) for t in hours) - pulp.lpSum(P_grid_sell[t] * sell_price for t in hours)

# RÃ€NG BUá»˜C
for t in hours:
    if t > 0:
        model += SOC[t] == SOC[t-1] + P_charge[t] * efficiency_charge - P_discharge[t] * (1 / efficiency_discharge)
    else:
        model += SOC[t] == initial_soc + P_charge[t] * efficiency_charge - P_discharge[t] * (1 / efficiency_discharge)

    model += P_discharge[t] + P_grid_buy[t] - P_charge[t] - P_grid_sell[t] == load_power[t] - pv_power[t]
    model += x_charge[t] + x_discharge[t] <= 1
    model += P_charge[t] <= max_charge_power * x_charge[t]
    model += P_discharge[t] <= max_discharge_power * x_discharge[t]
    P_pv_to_charge = pulp.LpVariable(f"P_pv_to_charge_{t}", 0)
# GIáº¢I BÃ€I TOÃN
model.solve()

# TÃNH TOÃN Káº¾T QUáº¢
buy_energy, sell_energy, charge_energy, discharge_energy, battery_state = [], [], [], [], []
buy_cost_per_hour, sell_revenue_per_hour = [], []
buy_cost_total, sell_revenue_total = 0, 0

for t in hours:
    P_buy = P_grid_buy[t].varValue
    P_sell = P_grid_sell[t].varValue
    P_chg = P_charge[t].varValue * efficiency_charge
    P_dis = P_discharge[t].varValue * (1 / efficiency_discharge)
    SOC_t = SOC[t].varValue

    buy_energy.append(P_buy)
    sell_energy.append(P_sell)
    charge_energy.append(P_chg)
    discharge_energy.append(P_dis)
    battery_state.append(SOC_t)

    buy_cost = P_buy * get_buy_price_by_time(t)
    revenue = P_sell * sell_price

    buy_cost_per_hour.append(buy_cost)
    sell_revenue_per_hour.append(revenue)

buy_cost_total = sum(buy_cost_per_hour)
sell_revenue_total = sum(sell_revenue_per_hour)
net_cost = buy_cost_total - sell_revenue_total

# IN Káº¾T QUáº¢
print("\nChi tiáº¿t láº­p lá»‹ch mua/bÃ¡n vÃ  sáº¡c/xáº£ Ä‘iá»‡n theo tá»«ng giá»:")
print("Giá» | Mua (kWh) | Chi phÃ­ (VNÄ) | BÃ¡n (kWh) | Doanh thu (VNÄ) | Sáº¡c (kWh) | Xáº£ (kWh) | SOC (kWh)")
print("-" * 90)
for t in hours:
    print(f"{t:2}  | {buy_energy[t]:8.2f} | {buy_cost_per_hour[t]:12.0f} | {sell_energy[t]:8.2f} | {sell_revenue_per_hour[t]:12.0f} | {charge_energy[t]:8.2f} | {discharge_energy[t]:8.2f} | {battery_state[t]:8.2f}")

# Tá»”NG Káº¾T
print("\nğŸ“Œ **Tá»•ng káº¿t:**")
print(f"ğŸ”¹ Tá»•ng Ä‘iá»‡n mua: {sum(buy_energy):.2f} kWh")
print(f"ğŸ”¹ Tá»•ng Ä‘iá»‡n bÃ¡n: {sum(sell_energy):.2f} kWh")
print(f"ğŸ”¹ Chi phÃ­ mua Ä‘iá»‡n: {buy_cost_total:.0f} VNÄ")
print(f"ğŸ”¹ Thu nháº­p tá»« bÃ¡n Ä‘iá»‡n: {sell_revenue_total:.0f} VNÄ")
print(f"ğŸ”¹ Tá»•ng chi phÃ­ thá»±c táº¿: {net_cost:.0f} VNÄ")

# Váº¼ BIá»‚U Äá»’
plt.figure(figsize=(10, 6))
plt.plot(hours, pv_power, 'b-o', label="CÃ´ng suáº¥t PV (kW)")
plt.plot(hours, load_power, 'orange', marker='o', linestyle='-', label="Phá»¥ táº£i (kW)")
plt.plot(hours, buy_energy, 'g-o', label="Mua tá»« lÆ°á»›i (kW)")
plt.plot(hours, sell_energy, 'r-o', label="BÃ¡n lÃªn lÆ°á»›i (kW)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("CÃ´ng suáº¥t (kW)")
plt.title("CÃ´ng suáº¥t PV, Phá»¥ táº£i, Mua/BÃ¡n theo giá»")
plt.xticks(hours)
plt.legend()
plt.grid()
plt.show()

plt.figure(figsize=(10, 6))
plt.plot(hours, battery_state, 'purple', marker='o', linestyle='-', label="SOC cá»§a pin (kWh)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("Dung lÆ°á»£ng pin (kWh)")
plt.title("Tráº¡ng thÃ¡i SOC cá»§a pin theo thá»i gian")
plt.xticks(hours)
plt.legend()
plt.grid()
plt.show()

cumulative_buy_cost = np.cumsum(buy_cost_per_hour)
cumulative_sell_revenue = np.cumsum(sell_revenue_per_hour)
plt.figure(figsize=(10, 6))
plt.plot(hours, cumulative_buy_cost, 'g-o', label="Chi phÃ­ mua tÃ­ch lÅ©y (VNÄ)")
plt.plot(hours, cumulative_sell_revenue, 'r-o', label="Doanh thu bÃ¡n tÃ­ch lÅ©y (VNÄ)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("VNÄ")
plt.title("Chi phÃ­ mua vÃ  doanh thu bÃ¡n Ä‘iá»‡n tÃ­ch lÅ©y")
plt.xticks(hours)
plt.legend()
plt.grid()
plt.show()
# In ra cÃ´ng suáº¥t sáº¡c (P_charge) theo tá»«ng giá»
print("\nCÃ´ng suáº¥t sáº¡c (P_charge) theo tá»«ng giá»:")
print("-" * 40)
for t in hours:
    print(f"Giá» {t:2}: P_charge = {P_charge[t].varValue:.2f} kW")

# Váº½ biá»ƒu Ä‘á»“ cÃ´ng suáº¥t sáº¡c theo giá»
plt.figure(figsize=(10, 6))
plt.plot(hours, [P_charge[t].varValue for t in hours], 'b-o', label="CÃ´ng suáº¥t sáº¡c (kW)")
plt.xlabel("Giá» trong ngÃ y")
plt.ylabel("CÃ´ng suáº¥t (kW)")
plt.title("CÃ´ng suáº¥t Sáº¡c theo giá» trong ngÃ y")
plt.xticks(hours)
plt.legend()
plt.grid()
plt.show()

# ===== âš¡ TÃNH Tá»¶ Lá»† Sá»¬ Dá»¤NG ÄIá»†N Máº¶T TRá»œI VÃ€ Sá» CHU Ká»² Sáº C/Xáº¢ =====

# Tá»•ng nÄƒng lÆ°á»£ng táº£i tiÃªu thá»¥ trong ngÃ y
total_load_energy = sum(load_power)

# Tá»•ng nÄƒng lÆ°á»£ng Ä‘Æ°á»£c cung cáº¥p tá»« pin (sau hiá»‡u suáº¥t)
total_discharge_supplied = sum([d * efficiency_discharge for d in discharge_energy])

# Tá»•ng nÄƒng lÆ°á»£ng tá»« PV Ä‘Æ°á»£c sá»­ dá»¥ng ná»™i bá»™ (PV trá»« pháº§n bÃ¡n lÃªn lÆ°á»›i)
total_pv_used_for_load_or_charge = sum([
    min(pv_power[i], load_power[i] + charge_energy[i] / efficiency_charge)
    for i in range(24)
])

# Tá»· lá»‡ sá»­ dá»¥ng Ä‘iá»‡n máº·t trá»i
solar_utilization_ratio = total_pv_used_for_load_or_charge / total_load_energy * 100

# TÃ­nh sá»‘ chu ká»³ sáº¡c/xáº£ trung bÃ¬nh:
# Chu ká»³ pin â‰ˆ Tá»•ng nÄƒng lÆ°á»£ng sáº¡c hoáº·c xáº£ trong ngÃ y chia cho dung lÆ°á»£ng pin
battery_cycles = min(
    sum(charge_energy) / capacity_battery,
    sum(discharge_energy) / capacity_battery
)

print("\n===== âš™ï¸ ÄÃ¡nh giÃ¡ hiá»‡u suáº¥t há»‡ thá»‘ng =====")
print(f"ğŸ”† Tá»· lá»‡ sá»­ dá»¥ng Ä‘iá»‡n máº·t trá»i:  {solar_utilization_ratio:.2f} % nhu cáº§u")
print(f"ğŸ”„ Sá»‘ chu ká»³ sáº¡c/xáº£ trong ngÃ y:  {battery_cycles:.2f} chu ká»³")

# ===== ğŸ”‹ TÃNH SOC CUá»I NGÃ€Y VÃ€ Tá»¶ Lá»† Xáº¢ PIN BAN ÄÃŠM =====

# SOC táº¡i thá»i Ä‘iá»ƒm cuá»‘i cÃ¹ng trong ngÃ y (sau giá» 23)
final_soc = battery_state[-1]

# XÃ¡c Ä‘á»‹nh cÃ¡c giá» ban Ä‘Ãªm: tá»« 18h Ä‘áº¿n 23h (tá»©c 18â€“23) + 0â€“5h hÃ´m sau
night_hours = list(range(0, 6)) + list(range(18, 24))

# Tá»•ng phá»¥ táº£i ban Ä‘Ãªm
night_load = sum([load_power[i] for i in night_hours])

# Tá»•ng nÄƒng lÆ°á»£ng xáº£ tá»« pin ban Ä‘Ãªm (tÃ­nh cáº£ hiá»‡u suáº¥t)
night_discharge_energy = sum([discharge_energy[i] * efficiency_discharge for i in night_hours])

# Tá»· lá»‡ phá»¥ táº£i ban Ä‘Ãªm do pin cung cáº¥p
night_supply_ratio = (night_discharge_energy / night_load) * 100 if night_load > 0 else 0

# In káº¿t quáº£
print("\n===== ğŸŒ™ ÄÃ¡nh giÃ¡ ban Ä‘Ãªm =====")
print(f"ğŸ”‹ SOC cuá»‘i ngÃ y (23h):                {final_soc:.2f} kWh")
print(f"ğŸŒ™ Tá»· lá»‡ táº£i ban Ä‘Ãªm do pin cung cáº¥p:  {night_supply_ratio:.2f} %")
